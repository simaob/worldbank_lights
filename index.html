<!DOCTYPE html>
<html>
<head>
  <title>World Bank Lights</title>
  <!-- based on leaflet quick example: http://leafletjs.com/examples/quick-start-example.html -->
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
  <!--[if lte IE 8]>
     <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" />
  <![endif]-->

  <link rel="stylesheet" href="http://libs.cartocdn.com/cartodb.js/v3/3.13/themes/css/cartodb.css" />
  <script src="http://libs.cartocdn.com/cartodb.js/v3/3.13/cartodb.js"></script>
  <style>
    html, body, #map { height: 100%; padding: 0; margin: 0;}
  </style>
</head>
<body>
  <div id="map"></div>

  <script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
  <script src="leaflet_canvas_layer.js"></script>
  <script>
    var map = L.map('map').setView([20.0, 80.0], 5);
    L.tileLayer('http://a.tile.stamen.com/toner/{z}/{x}/{y}.png', {
      maxZoom: 14,
      attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery <a href="http://stamen.com">Stamen</a>'
    }).addTo(map);

    var IndiaLayer = L.CanvasLayer.extend({

      defaults: {
        cartodbUserName: 'simbiotica',
        dataMaxZoom: 14,
      },

      init: function() {
        this.tiles = {};
        this.cartoSQL = new cartodb.SQL({
          user: 'simbiotica'
        });
      },

      _getCanvas: function(coord, zoom, ownerDocument) {
        // create canvas and reset style
        var canvas = ownerDocument.createElement('canvas');
        canvas.style.border = 'none';
        canvas.style.margin = '0';
        canvas.style.padding = '0';

        // prepare canvas and context sizes
        var ctx = canvas.getContext('2d');
        ctx.width = canvas.width = this.tileSize.width;
        ctx.height = canvas.height = this.tileSize.height;

        canvas.ctx = ctx;
        return canvas;
      },

      getTile: function(coord, zoom, ownerDocument) {
        var canvas = this._getCanvas(coord, zoom, ownerDocument);
        var sql = this._getSQL(coord.x, coord.y, zoom);
        var zoomDiff = zoom + 8 - Math.min(zoom + 8, 16);

        this.cartoSQL.execute(sql, _.bind(function(data) {
          if (!data) {return;}

          var tile = {
            canvas: canvas,
            ctx: canvas.ctx,
            width: this.tileSize.width,
            coord: coord,
            zoom: zoom,
            height: this.tileSize.height,
            cells: this.preCacheMonths(data.rows, coord, zoom,
              zoomDiff)
          };

          //set unique id
          var tileId = '{0}_{1}_{2}'.format(coord.x, coord.y, zoom);
          canvas.setAttribute('id', tileId);

          if (tileId in this.tiles) {
            delete this.tiles[tileId];
          }

          this.tiles[tileId] = tile;

          this._render(tile);
        }, this));

        return canvas;
      },

      _getSQL: function(x, y, z) {
        // zoom + 8 is get because a tile in 'zoom' zoom level is a pixel in 'zoom + 8'
        // level. Remember, it is a quadtree, 1^8 = 256 and tile size is 256px
        var pixel_zoom = Math.min(z, 14);
        //var zoom_diff = z + 8 - pixel_zoom;

        // get x, y for cells and sd, se for deforestation changes
        // sd contains the months
        // se contains the deforestation for each entry in sd
        // take se and sd as a matrix [se|sd]
        console.log(x, ', ', y, ', ', z);
        var sql = _.str.sprintf(
          'SELECT (pixelx + tilex*256) AS x, (pixely + tiley*256) AS y, averagevis FROM %(tableName)s WHERE zoom = %(z)s  AND tilex = %(tilex)s AND tiley = %(tiley)s'+
          ' AND month = 11 AND day = 2', {
            tableName: 'india_tiles',
            tilex: x,
            tiley: y,
            z: pixel_zoom
          });

        return sql;
      },
      render: function() {
        var canvas = this.getCanvas();
        var ctx = canvas.getContext('2d');
      },

      _render: function(tile) {
        if(!tile) {
          return;
        }
        var w = tile.canvas.width;
        var ctx = tile.ctx;
        var cells = tile.cells;

        if (!cells || cells.length === 0) {
          return;
        }

        // clear canvas
        tile.canvas.width = w;
        ctx.fillStyle = '#F69';

        var xc = cells.xcoords;
        var yc = cells.ycoords;
        var averagevis = cells.averagevis;

        // render cells
        var len = cells.length;
        var pixel_size = cells.size;
        for (var i = 0; i < len; ++i) {
          ctx.globalAlpha= averagevis[i]/100;
          ctx.fillRect(xc[i], yc[i], pixel_size, pixel_size);
        }
      },

      preCacheMonths: function(rows, coord, zoom, zoom_diff) {
        var row;
        var xcoords;
        var ycoords;
        var averagevis;

        if (typeof(ArrayBuffer) !== 'undefined') {
          xcoords = new Uint8Array(new ArrayBuffer(rows.length));
          ycoords = new Uint8Array(new ArrayBuffer(rows.length));
          averagevis = new Uint8Array(new ArrayBuffer(rows.length));
        } else {
          // fallback
          xcoords = [];
          ycoords = [];
          averagevis = [];
          // array buffer set by default to 0
          // fucking javascript arrays not
          for (var r = 0; r < rows.length * MAX_MONTHS; ++r) {
            averagevis[r] = 0;
          }
        }
        for (var i in rows) {
          row = rows[i];
          xcoords[i] = row.x;
          ycoords[i] = row.y;
          averagevis[i] = row.averagevis
        }

        return {
          length: rows.length,
          xcoords: xcoords,
          ycoords: ycoords,
          averagevis: averagevis,
          size: 1
        };
      },

      updateTiles: function() {
        _.each(this.tiles, _.bind(function(tile) {
          this._render(tile);
        }, this));
      }

    });
    var layer = new IndiaLayer();
    layer.addTo(map);
  </script>
</body>
</html>
